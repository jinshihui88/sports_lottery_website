<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sports.lottery.mapper.BettingRecordMapper">

    <!-- 按日期统计投注数据 -->
    <select id="getDailyStatistics" resultType="java.util.Map">
        SELECT 
            DATE(match_date) as date,
            COUNT(*) as betCount,
            SUM(bet_amount) as totalBetAmount,
            SUM(CASE WHEN win_amount IS NOT NULL THEN win_amount ELSE 0 END) as totalWinAmount,
            SUM(CASE WHEN win_amount IS NOT NULL THEN win_amount ELSE 0 END) - SUM(bet_amount) as netProfit,
            COUNT(CASE WHEN result = 'WIN' THEN 1 END) as winCount,
            COUNT(CASE WHEN result = 'LOSE' THEN 1 END) as loseCount,
            COUNT(CASE WHEN result = 'DRAW' THEN 1 END) as drawCount
        FROM betting_record 
        WHERE user_id = #{userId}
        <if test="startDate != null">
            AND match_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND match_date <= #{endDate}
        </if>
        GROUP BY DATE(match_date)
        ORDER BY DATE(match_date) DESC
    </select>

    <!-- 按联赛统计投注数据 -->
    <select id="getLeagueStatistics" resultType="java.util.Map">
        SELECT 
            league,
            COUNT(*) as betCount,
            SUM(bet_amount) as totalBetAmount,
            SUM(CASE WHEN win_amount IS NOT NULL THEN win_amount ELSE 0 END) as totalWinAmount,
            SUM(CASE WHEN win_amount IS NOT NULL THEN win_amount ELSE 0 END) - SUM(bet_amount) as netProfit,
            COUNT(CASE WHEN result = 'WIN' THEN 1 END) as winCount,
            COUNT(CASE WHEN result = 'LOSE' THEN 1 END) as loseCount,
            COUNT(CASE WHEN result = 'DRAW' THEN 1 END) as drawCount,
            ROUND(COUNT(CASE WHEN result = 'WIN' THEN 1 END) * 100.0 / COUNT(*), 2) as winRate
        FROM betting_record 
        WHERE user_id = #{userId}
        <if test="startDate != null">
            AND match_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND match_date <= #{endDate}
        </if>
        GROUP BY league
        ORDER BY betCount DESC
    </select>

    <!-- 按投注类型统计数据 -->
    <select id="getBetTypeStatistics" resultType="java.util.Map">
        SELECT 
            bet_type as betType,
            COUNT(*) as betCount,
            SUM(bet_amount) as totalBetAmount,
            SUM(CASE WHEN win_amount IS NOT NULL THEN win_amount ELSE 0 END) as totalWinAmount,
            SUM(CASE WHEN win_amount IS NOT NULL THEN win_amount ELSE 0 END) - SUM(bet_amount) as netProfit,
            COUNT(CASE WHEN result = 'WIN' THEN 1 END) as winCount,
            COUNT(CASE WHEN result = 'LOSE' THEN 1 END) as loseCount,
            COUNT(CASE WHEN result = 'DRAW' THEN 1 END) as drawCount,
            ROUND(COUNT(CASE WHEN result = 'WIN' THEN 1 END) * 100.0 / COUNT(*), 2) as winRate
        FROM betting_record 
        WHERE user_id = #{userId}
        <if test="startDate != null">
            AND match_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND match_date <= #{endDate}
        </if>
        GROUP BY bet_type
        ORDER BY betCount DESC
    </select>

</mapper>